from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///room_finder.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), nullable=False)
    user_type = db.Column(db.String(10), nullable=False)  # 'finder' or 'owner'

class RoomDetails(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    owner_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    location = db.Column(db.String(100), nullable=False)
    price = db.Column(db.Float, nullable=False)
    room_type = db.Column(db.String(50), nullable=False)  # e.g., '1BHK', '2BHK'
    description = db.Column(db.Text, nullable=True)

class FinderPreferences(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    finder_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    location = db.Column(db.String(100), nullable=False)
    budget = db.Column(db.Float, nullable=False)
    room_type = db.Column(db.String(50), nullable=False)

@app.route('/register', methods=['POST'])
def register_user():
    data = request.json
    username = data.get('username')
    user_type = data.get('user_type')

    if user_type not in ['finder', 'owner']:
        return jsonify({"error": "Invalid user type."}), 400

    user = User(username=username, user_type=user_type)
    db.session.add(user)
    db.session.commit()

    return jsonify({"message": "User registered successfully.", "user_id": user.id})

@app.route('/add_room', methods=['POST'])
def add_room():
    data = request.json
    owner_id = data.get('owner_id')
    location = data.get('location')
    price = data.get('price')
    room_type = data.get('room_type')
    description = data.get('description', '')

    owner = User.query.get(owner_id)
    if not owner or owner.user_type != 'owner':
        return jsonify({"error": "Invalid owner ID."}), 400

    room = RoomDetails(owner_id=owner_id, location=location, price=price, room_type=room_type, description=description)
    db.session.add(room)
    db.session.commit()

    return jsonify({"message": "Room added successfully.", "room_id": room.id})

@app.route('/set_preferences', methods=['POST'])
def set_preferences():
    data = request.json
    finder_id = data.get('finder_id')
    location = data.get('location')
    budget = data.get('budget')
    room_type = data.get('room_type')

    finder = User.query.get(finder_id)
    if not finder or finder.user_type != 'finder':
        return jsonify({"error": "Invalid finder ID."}), 400

    preferences = FinderPreferences(finder_id=finder_id, location=location, budget=budget, room_type=room_type)
    db.session.add(preferences)
    db.session.commit()

    return jsonify({"message": "Preferences set successfully.", "preferences_id": preferences.id})

@app.route('/search_rooms', methods=['GET'])
def search_rooms():
    finder_id = request.args.get('finder_id')
    finder = User.query.get(finder_id)
    if not finder or finder.user_type != 'finder':
        return jsonify({"error": "Invalid finder ID."}), 400

    preferences = FinderPreferences.query.filter_by(finder_id=finder_id).first()
    if not preferences:
        return jsonify({"error": "Preferences not set for this finder."}), 400

    rooms = RoomDetails.query.filter(
        RoomDetails.location == preferences.location,
        RoomDetails.price <= preferences.budget,
        RoomDetails.room_type == preferences.room_type
    ).all()

    room_list = [{
        "room_id": room.id,
        "location": room.location,
        "price": room.price,
        "room_type": room.room_type,
        "description": room.description
    } for room in rooms]

    return jsonify({"rooms": room_list})

if __name__ == '__main__':
    db.create_all()
    app.run(debug=True)


